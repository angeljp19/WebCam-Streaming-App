<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Document</title>
    <script src="/socket.io/socket.io.js"></script>
    <link rel="stylesheet" href="./output.css">
</head>
<style>
    body, html {
        margin: 0;
        padding: 0;
        width: 100%;
        height: 100%;
        overflow: hidden;
    }
    #container {
        width: 100px;
        height: 100px;
        background-color: rgba(255,255,255,0.4);
        border-radius: 50%;
        position: absolute;
        top: 10px;
        left: 10px;
        z-index: 10; /* Ensure joystick is on top */
    }
    #joystick {
        width: 25px;
        height: 25px;
        background-color: rgba(255,0,0,0.6);
        border-radius: 50%;
        position: absolute;
        top: 37px;
        left: 37px;
    }
</style>
<body class="w-full h-full m-0 p-0 relative ">
    <img class="w-screen h-screen pointer-events-none" id="play" src="" alt="">
    <div id="container">
        <div id="joystick"></div>
    </div>
    <button  class="font-mono font-bold absolute bottom-10 left-10 text-2xl transform pointer-events-none"><img class="w-10 h-auto" src="./image.png" alt=""></button>
    <div id="mic-button" class="absolute bottom-3 left-3 w-24 h-24 bg-gray-400 opacity-25 rounded-full cursor-pointer active:opacity-40"></div>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script>
        var socket = io();

        socket.on('stream', (image) => {
            let img = document.getElementById('play');
            img.src = image;
        });

        const container = document.getElementById('container');
        const joystick = document.getElementById('joystick');

        let isDragging = false;
        let intervalId = null;
        let currentOffsetX = 0;
        let currentOffsetY = 0;

        joystick.addEventListener('mousedown', startDrag);
        joystick.addEventListener('touchstart', startDrag);

        function startDrag(event) {
            event.preventDefault();
            isDragging = true;
            document.addEventListener('mousemove', drag);
            document.addEventListener('touchmove', drag);
            document.addEventListener('mouseup', stopDrag);
            document.addEventListener('touchend', stopDrag);

            if (!intervalId) {
                intervalId = setInterval(() => {
                    socket.emit('direccion', { x: Math.round(currentOffsetX), y: Math.round(currentOffsetY) });
                }, 100);
            }
        }

        function drag(event) {
            if (!isDragging) return;

            const bounds = container.getBoundingClientRect();
            let x, y;

            if (event.type === 'mousemove') {
                x = event.clientX - bounds.left - container.offsetWidth / 2;
                y = event.clientY - bounds.top - container.offsetHeight / 2;
            } else if (event.type === 'touchmove') {
                x = event.touches[0].clientX - bounds.left - container.offsetWidth / 2;
                y = event.touches[0].clientY - bounds.top - container.offsetHeight / 2;
            }

            const distance = Math.min(Math.sqrt(x * x + y * y), container.offsetWidth / 2);
            const angle = Math.atan2(y, x);
            const offsetX = Math.cos(angle) * distance;
            const offsetY = Math.sin(angle) * distance;

            currentOffsetX = offsetX;
            currentOffsetY = offsetY;

            joystick.style.transform = `translate(${offsetX}px, ${offsetY}px)`;
        }

        function stopDrag(event) {
            isDragging = false;
            document.removeEventListener('mousemove', drag);
            document.removeEventListener('touchmove', drag);
            document.removeEventListener('mouseup', stopDrag);
            document.removeEventListener('touchend', stopDrag);
            joystick.style.transform = 'translate(0px, 0px)';

            if (intervalId) {
                clearInterval(intervalId);
                intervalId = null;
            }
        }

        let isPressing = false;
        let pressTimer;
        let interval;

        const startPress = () => {
            isPressing = true;
            pressTimer = setTimeout(() => {
                if (isPressing) {
                    console.log("Micrófono activado");
                    interval = setInterval(() => {
                        if (isPressing) {
                            socket.emit('mic', { mic: 'activado' });
                        }
                    }, 100); // Intervalo en milisegundos para chequear mientras está presionado
                }
            }, 500); // Tiempo que considera el botón presionado
        };

        const endPress = () => {
            if (isPressing) {
                clearTimeout(pressTimer);
                clearInterval(interval);
                isPressing = false;
                console.log("Micrófono desactivado"); // Reemplaza con la lógica para desactivar el micrófono
            }
        };

        const button = document.getElementById('mic-button');
        button.addEventListener('mousedown', startPress);
        button.addEventListener('mouseup', endPress);
        button.addEventListener('mouseleave', endPress);
        button.addEventListener('touchstart', startPress);
        button.addEventListener('touchend', endPress);
        button.addEventListener('touchcancel', endPress);
    </script>
</body>
</html>
